# 画面遷移図

**システム名：iLスクエア予約システム**　　　　　　　　　　　　　　　　　　　　**2025年6月14日**

**サブシステム：3ステップ予約フロー**　　　　　　　　　　　　　　　　　　　　**特記事項：実装完了版**

---

## 画面遷移図

```
                    ┌─────────────────┐
                    │   トップ画面    │
                    │    (top.html)   │
                    └─────────┬───────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │ ユーザー登録 │  │  ログイン   │  │ 予約ステップ1│
    │(register.html)│  │(login.html) │  │(step1.html) │
    └─────┬───────┘  └─────┬───────┘  └─────┬───────┘
            │                  │               │
            │                  ▼               │
            │        ┌─────────────────┐       │
            │        │   マイページ    │       │
            │        │ (mypage.html)   │       │
            │        └─────┬───────────┘       │
            │              │                   │
            └──────────────┼───────────────────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              ▼              ▼
  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
  │ 予約ステップ1│ │ 予約履歴    │ │プロフィール │
  │(step1.html) │ │(reservations)│ │(profile.html)│
  └─────┬───────┘ └─────────────┘ └─────────────┘
          │
          ▼
  ┌─────────────┐
  │ 予約ステップ2│
  │(step2.html) │
  └─────┬───────┘
          │
          ▼
  ┌─────────────┐
  │予約ステップ2.5│
  │(step2_5.html)│
  └─────┬───────┘
          │
          ▼
  ┌─────────────┐
  │ 予約ステップ3│
  │(step3.html) │
  └─────┬───────┘
          │
          ▼
  ┌─────────────┐
  │ 予約完了    │
  │(complete.html)│
  └─────────────┘
```

---

## 画面一覧

| 画面ID | 画面名 | ファイル名 | 説明 | アクセス権限 | 実装状況 |
|--------|--------|------------|------|-------------|----------|
| S001 | トップ画面 | top.html | サービス概要と3ステップ案内 | 全ユーザー | ✅完了 |
| S002 | ユーザー登録画面 | register.html | 新規ユーザーアカウント作成 | 未登録ユーザー | ✅完了 |
| S003 | ログイン画面 | login.html | 登録済みユーザーの認証 | 未ログインユーザー | ✅完了 |
| S004 | マイページ | mypage.html | ユーザー専用ダッシュボード | ログインユーザー | ✅完了 |
| S005 | 予約ステップ1 | reserve_step1.html | 日付選択 | ログインユーザー | ✅完了 |
| S006 | 予約ステップ2 | reserve_step2.html | スペース・開始時刻選択 | ログインユーザー | ✅完了 |
| S007 | 予約ステップ2.5 | reserve_step2_5.html | 終了時刻選択 | ログインユーザー | ✅完了 |
| S008 | 予約ステップ3 | reserve_step3.html | 予約内容確認 | ログインユーザー | ✅完了 |
| S009 | 予約完了画面 | reserve_complete.html | 予約完了通知 | ログインユーザー | ✅完了 |
| S010 | 予約履歴画面 | reservations.html | 現在の予約・利用履歴 | ログインユーザー | ✅完了 |
| S011 | プロフィール画面 | profile.html | ユーザー情報確認・変更 | ログインユーザー | ✅完了 |

---

## 画面遷移パターン

### 1. 新規ユーザーの予約フロー（実装済み）
```
トップ画面 → ユーザー登録画面 → ログイン画面 → マイページ → 
予約ステップ1 → 予約ステップ2 → 予約ステップ2.5 → 予約ステップ3 → 予約完了画面
```

### 2. 既存ユーザーの予約フロー（実装済み）
```
トップ画面 → ログイン画面 → マイページ → 
予約ステップ1 → 予約ステップ2 → 予約ステップ2.5 → 予約ステップ3 → 予約完了画面
```

### 3. 直接予約フロー（実装済み）
```
トップ画面 → 予約ステップ1（自動ログイン要求）→ 
ログイン画面 → 予約ステップ1 → 予約ステップ2 → 予約ステップ2.5 → 予約ステップ3 → 予約完了画面
```

### 4. 予約管理フロー（実装済み）
```
マイページ → 予約履歴画面 → 予約詳細/キャンセル
```

### 5. アカウント管理フロー（実装済み）
```
マイページ → プロフィール画面 → 情報更新
```

---

## 3ステップ予約フローの詳細遷移

### 実装済み予約フロー
```
【ステップ1：日付選択】
reserve_step1.html
    │
    ▼ 日付選択後
【ステップ2：スペース・開始時刻選択】  
reserve_step2.html
    │
    ▼ スペース・開始時刻選択後
【ステップ2.5：終了時刻選択】
reserve_step2_5.html
    │
    ▼ 終了時刻選択後
【ステップ3：予約確認】
reserve_step3.html
    │
    ▼ 予約確定後
【ステップ4：予約完了】
reserve_complete.html
```

### フロー間のデータ受け渡し
1. **セッション管理**: 各ステップの選択内容をセッションで保持
2. **データ構造**: 
   - `selected_date`: 選択日付
   - `space_id`: 選択スペースID
   - `start_time`: 開始時刻
   - `end_time`: 終了時刻
3. **検証**: 各ステップでデータ整合性チェック実装済み

---

## 遷移条件

| 遷移元 | 遷移先 | 条件 | 実装状況 |
|--------|--------|------|----------|
| トップ画面 | ユーザー登録画面 | 「新規登録」ボタンクリック | ✅完了 |
| トップ画面 | ログイン画面 | 「ログイン」ボタンクリック | ✅完了 |
| トップ画面 | 予約ステップ1 | 「予約申込を始める」ボタンクリック | ✅完了 |
| ユーザー登録画面 | ログイン画面 | 登録成功後 | ✅完了 |
| ログイン画面 | マイページ | 認証成功後 | ✅完了 |
| マイページ | 予約ステップ1 | 「新規予約」ボタンクリック | ✅完了 |
| マイページ | 予約履歴画面 | 「予約履歴」ボタンクリック | ✅完了 |
| マイページ | プロフィール画面 | 「プロフィール」ボタンクリック | ✅完了 |
| 予約ステップ1 | 予約ステップ2 | 日付選択後「次へ進む」 | ✅完了 |
| 予約ステップ2 | 予約ステップ2.5 | スペース・開始時刻選択後 | ✅完了 |
| 予約ステップ2.5 | 予約ステップ3 | 終了時刻選択後「確認画面へ」 | ✅完了 |
| 予約ステップ3 | 予約完了画面 | 「予約確定」ボタンクリック | ✅完了 |
| 予約完了画面 | マイページ | 「マイページへ」ボタンクリック | ✅完了 |
| 予約完了画面 | 予約ステップ1 | 「新規予約」ボタンクリック | ✅完了 |

---

## エラー処理・例外遷移

| エラー種別 | 発生条件 | 遷移先 | 表示メッセージ | 実装状況 |
|------------|----------|--------|----------------|----------|
| 認証エラー | ログイン失敗 | ログイン画面 | 「ユーザーIDまたはパスワードが正しくありません」 | ✅完了 |
| 未認証アクセス | ログイン必須画面への直接アクセス | ログイン画面 | 「ログインが必要です」 | ✅完了 |
| 入力エラー | 必須項目未入力 | 同じ画面 | 「必須項目を入力してください」 | ✅完了 |
| 予約エラー | 既に予約済み時間帯選択 | 予約ステップ2 | 「選択した時間は既に予約されています」 | ✅完了 |
| セッションエラー | セッション期限切れ | ログイン画面 | 「セッションが切れました。再度ログインしてください」 | ✅完了 |
| データ不整合 | 予約データの不正 | 予約ステップ1 | 「予約内容が正しくありません。最初からやり直してください」 | ✅完了 |

---

## 削除された画面（実装時に簡素化）

| 削除された画面 | 理由 | 代替手段 |
|---------------|------|----------|
| スペース一覧画面 | ナビゲーション複雑化 | トップ画面のスペース案内 |
| スケジュール画面 | 予約フローと重複 | 予約ステップでの空き状況表示 |

---

## 実装時の改善点

### 1. フローの簡素化
- **変更前**: 複雑なテーブル型一括選択
- **変更後**: 3段階の明確な選択フロー

### 2. ナビゲーションの統一
- **変更前**: 各画面で異なるヘッダーデザイン
- **変更後**: 統一されたヘッダーボタン

### 3. エラーハンドリングの強化
- **変更前**: 基本的なバリデーションのみ
- **変更後**: 包括的なエラー処理とユーザーガイダンス

### 4. データフローの最適化
- **変更前**: 複雑なセッションデータ構造
- **変更後**: シンプルで確実なデータ受け渡し

---

## 改訂履歴

| 版 | 改訂日 | 改訂者 | 改訂内容 |
|----|--------|--------|----------|
| 1.0 | 2025/06/14 | 田中一郎 | 新規作成 |
| 2.0 | 2025/06/14 | 田中一郎 | 3ステップフロー実装完了版への全面改訂 |

---

**作成者：Aチーム**　　　　　　　　　　　　　　　　　　　　　　　　　　**承認者：田中一郎**